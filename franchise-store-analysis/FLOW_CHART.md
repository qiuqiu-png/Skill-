# 加盟新老店批发毛利分析 - 完整流程图与计算公式

## 📊 数据流程总览

```
┌─────────────────────────────────────────────────────────────────────┐
│                          输入数据源 (5个)                              │
├─────────────────────────────────────────────────────────────────────┤
│ 1. 销售结算明细表 (必需)                                              │
│ 2. 退货结算明细表 (必需)                                              │
│ 3. 组织匹配表 (必需)                                                  │
│ 4. 加盟入库单 (可选 - 用于黄金外采-新模式)                            │
│ 5. 其他结算单 (可选 - 用于黄金外采-新模式)                            │
└─────────────────────────────────────────────────────────────────────┘
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        步骤1: 读取组织匹配表                           │
├─────────────────────────────────────────────────────────────────────┤
│ • 识别2025年新店 (2025年新店='是')                                    │
│ • 识别已闭店 (已闭店='是')                                             │
│ • 处理组织名称: 去除末尾的*和M                                         │
└─────────────────────────────────────────────────────────────────────┘
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    步骤2: 读取并预处理销售/退货数据                      │
├─────────────────────────────────────────────────────────────────────┤
│ 销售数据:                                                             │
│   1. 只保留组织名称以M结尾的门店                                       │
│   2. 处理组织名称 (去除*和M)                                           │
│   3. 剔除已闭店数据                                                   │
│   4. 标记新店/老店 (是否新店 = 是否在new_stores集合中)                 │
│   5. 确保数值列为数字类型                                             │
│                                                                       │
│ 退货数据: 同样的处理步骤                                               │
└─────────────────────────────────────────────────────────────────────┘
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│              步骤3: 读取并预处理入库单数据 (如果提供)                    │
├─────────────────────────────────────────────────────────────────────┤
│ 应用5条过滤规则:                                                       │
│   1. 门店含"宁波开元"且时间>=2025-01-01的不计入                        │
│   2. 门店含"慈溪附海"且时间>=2025-04-25的不计入                        │
│   3. 门店含"绍兴斗门"的不计入                                          │
│   4. 单据编码以"JMCX"开头的不计入                                      │
│   5. 仅保留大类='足金'                                                 │
│                                                                       │
│ 然后执行:                                                             │
│   1. 只保留组织名称以M结尾的门店                                       │
│   2. 处理组织名称 (去除*和M)                                           │
│   3. 剔除已闭店数据                                                   │
│   4. 标记新店/老店                                                    │
└─────────────────────────────────────────────────────────────────────┘
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│            步骤4: 读取并预处理其他结算单数据 (如果提供)                  │
├─────────────────────────────────────────────────────────────────────┤
│ 筛选条件:                                                             │
│   • 状态 = '已扣款'                                                   │
│   • 结算类型 = '服务费(挂标签）'                                       │
│                                                                       │
│ 然后执行:                                                             │
│   1. 只保留组织名称以M结尾的门店                                       │
│   2. 处理组织名称 (去除*和M)                                           │
│   3. 剔除已闭店数据                                                   │
│   4. 标记新店/老店                                                    │
└─────────────────────────────────────────────────────────────────────┘
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    步骤5: 检查组织匹配情况                             │
├─────────────────────────────────────────────────────────────────────┤
│ • 收集所有数据源中的组织                                               │
│ • 找出不在组织匹配表中的组织                                           │
│ • 如有缺失,输出警告 (这些组织将被视为老店)                             │
└─────────────────────────────────────────────────────────────────────┘
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    步骤6: 按品类统计计算                               │
├─────────────────────────────────────────────────────────────────────┤
│ 品类列表: ['黄金外采-新模式', '黄金', '钻石', '爱尚炫',                │
│            '18K', '翡翠', '其他']                                     │
│                                                                       │
│ 对每个品类:                                                           │
│   IF 品类 == '黄金外采-新模式':                                        │
│      → 使用特殊计算逻辑 (入库单+其他结算单)                            │
│   ELSE:                                                               │
│      → 使用常规计算逻辑 (销售表+退货表)                                │
└─────────────────────────────────────────────────────────────────────┘
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    步骤7: 计算合计和总计                               │
├─────────────────────────────────────────────────────────────────────┤
│ 合计 = 黄金 + 钻石 + 爱尚炫 + 18K + 翡翠 + 其他                        │
│      (不包含"黄金外采-新模式")                                         │
│                                                                       │
│ 总计 = 合计 + 黄金外采-新模式                                          │
└─────────────────────────────────────────────────────────────────────┘
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    步骤8: 美化并输出Excel                              │
├─────────────────────────────────────────────────────────────────────┤
│ • 生成美化的Excel报表                                                 │
│ • 包含蓝色表头、千分位格式、百分比格式                                 │
│ • 添加底部注释                                                        │
└─────────────────────────────────────────────────────────────────────┘
```

## 🧮 完整计算公式

### 1️⃣ 常规品类 (黄金、钻石、爱尚炫、18K、翡翠、其他)

#### 数据来源
- **销售表**: 包含销售金额、暂估成本、组织、品类
- **退货表**: 包含退回金额、暂估成本、组织、品类

#### 新老店区分
```python
# 根据组织匹配表判断
是否新店 = 组织 in new_stores集合
```

#### 计算公式

**老店批发（含税）**
```
老店批发2025 = Σ(老店销售金额) - Σ(老店退回金额)

其中:
  老店销售 = 销售表中 [是否新店=False AND 品类=当前品类] 的记录
  老店退货 = 退货表中 [是否新店=False AND 品类=当前品类] 的记录
```

**新店批发（含税）**
```
新店批发2025 = Σ(新店销售金额) - Σ(新店退回金额)

其中:
  新店销售 = 销售表中 [是否新店=True AND 品类=当前品类] 的记录
  新店退货 = 退货表中 [是否新店=True AND 品类=当前品类] 的记录
```

**老店毛利（未税）**
```
老店毛利2025 = [(Σ老店销售金额 - Σ老店暂估成本) / 1.13] 
               - [(Σ老店退回金额 - Σ老店暂估成本) / 1.13]

简化为:
老店毛利2025 = [(Σ老店销售金额 - Σ老店退回金额) 
               - (Σ老店销售暂估成本 - Σ老店退货暂估成本)] / 1.13
```

**新店毛利（未税）**
```
新店毛利2025 = [(Σ新店销售金额 - Σ新店暂估成本) / 1.13] 
               - [(Σ新店退回金额 - Σ新店暂估成本) / 1.13]

简化为:
新店毛利2025 = [(Σ新店销售金额 - Σ新店退回金额) 
               - (Σ新店销售暂估成本 - Σ新店退货暂估成本)] / 1.13
```

### 2️⃣ 黄金外采-新模式 (特殊品类)

#### 数据来源
- **入库单**: 包含总成本、组织 (经过5条过滤规则)
- **其他结算单**: 包含发生金额、组织 (筛选条件: 状态='已扣款' AND 结算类型='服务费(挂标签）')

#### 新老店区分
```python
# 根据组织匹配表判断
是否新店 = 组织 in new_stores集合
```

#### 计算公式

**老店批发（含税）**
```
老店批发2025 = 老店入库单总成本 + (老店其他结算单发生金额 / 1.06)

其中:
  老店入库单 = 入库单中 [是否新店=False] 的记录
  老店其他结算单 = 其他结算单中 [是否新店=False] 的记录
  
详细计算:
  老店入库单总成本 = Σ(老店入库单['总成本'])
  老店结算金额 = Σ(老店其他结算单['发生金额']) / 1.06
  老店批发2025 = 老店入库单总成本 + 老店结算金额
```

**新店批发（含税）**
```
新店批发2025 = 新店入库单总成本 + (新店其他结算单发生金额 / 1.06)

其中:
  新店入库单 = 入库单中 [是否新店=True] 的记录
  新店其他结算单 = 其他结算单中 [是否新店=True] 的记录
  
详细计算:
  新店入库单总成本 = Σ(新店入库单['总成本'])
  新店结算金额 = Σ(新店其他结算单['发生金额']) / 1.06
  新店批发2025 = 新店入库单总成本 + 新店结算金额
```

**老店毛利（未税）**
```
老店毛利2025 = Σ(老店其他结算单['发生金额']) / 1.06
```

**新店毛利（未税）**
```
新店毛利2025 = Σ(新店其他结算单['发生金额']) / 1.06
```

## 📋 入库单5条过滤规则详解

### 规则1: 门店含"宁波开元"且时间>=2025-01-01的不计入
```python
if time_col:  # 业务时间 或 创建时间
    df['时间_dt'] = pd.to_datetime(df[time_col], errors='coerce')
    ningbo_kaiyuan_mask = df['组织'].str.contains('宁波开元', na=False) & \
                          (df['时间_dt'] >= pd.Timestamp('2025-01-01'))
    df = df[~ningbo_kaiyuan_mask]
```
**说明**:
- "宁波开元"门店在2025年之前（2024年及之前）的记录保留
- 2025-01-01及之后的记录删除

### 规则2: 门店含"慈溪附海"且时间>=2025-04-25的不计入
```python
if time_col:  # 业务时间 或 创建时间
    df['时间_dt'] = pd.to_datetime(df[time_col], errors='coerce')
    cixi_fuhai_mask = df['组织'].str.contains('慈溪附海', na=False) & \
                     (df['时间_dt'] >= pd.Timestamp('2025-04-25'))
    df = df[~cixi_fuhai_mask]
```
**说明**:
- "慈溪附海"门店在2025-04-25之前的记录保留
- 2025-04-25及之后的记录删除

### 规则3: 门店含"绍兴斗门"的不计入
```python
df = df[~df['组织'].str.contains('绍兴斗门', na=False)]
```
**说明**: 无条件删除所有"绍兴斗门"门店的记录 (不分年份)

### 规则4: 单据编码以"JMCX"开头的不计入
```python
# 查找单据编码字段: '单号', '单据编码', '加盟收货单'
if doc_col:
    df = df[~df[doc_col].str.startswith('JMCX', na=False)]
```
**说明**: 删除单据编码以"JMCX"开头的所有记录

### 规则5: 仅保留大类='足金'
```python
if '大类' in df.columns:
    df = df[df['大类'] == '足金']
```
**说明**: 只保留大类字段为"足金"的记录,其他大类全部过滤

## 🔄 数据处理通用步骤

每个数据源都会经过以下处理:

### 步骤1: 只保留M结尾的门店
```python
df = df[df['组织'].str.rstrip().str.endswith('M', na=False)]
```

### 步骤2: 清理组织名称
```python
df['组织_cleaned'] = df['组织'].str.replace(r'[*M]+$', '', regex=True)
```
**示例**: 
- `3A-杭州西湖银泰M` → `3A-杭州西湖银泰`
- `3C-宁波天一M*` → `3C-宁波天一`

### 步骤3: 剔除已闭店
```python
df = df[~df['组织_cleaned'].isin(closed_stores)]
```

### 步骤4: 标记新店/老店
```python
df['是否新店'] = df['组织_cleaned'].isin(new_stores)
```

## 📊 输出字段说明

### 每个品类的输出字段

| 字段名 | 说明 | 数据类型 |
|--------|------|---------|
| 品类 | 品类名称 | 文本 |
| 老店批发（含税）_2024年 | 2024年老店批发额 | 数字 (目前为0) |
| 老店批发（含税）_2025年 | 2025年老店批发额 | 数字 |
| 老店批发（含税）_同比增长率 | (2025-2024)/2024 | 百分比 (目前为0) |
| 老店批发（含税）_同比差异 | 2025-2024 | 数字 (目前为0) |
| 新店批发（含税）_2025年 | 2025年新店批发额 | 数字 |
| 2025年新老店合计_批发额 | 老店+新店批发额 | 数字 |
| 2025年新老店合计_同比增长率 | 合计同比增长率 | 百分比 (目前为0) |
| 老店毛利（未税）_2024年 | 2024年老店毛利额 | 数字 (目前为0) |
| 老店毛利（未税）_2025年 | 2025年老店毛利额 | 数字 |
| 老店毛利（未税）_同比增长率 | (2025-2024)/2024 | 百分比 (目前为0) |
| 老店毛利（未税）_同比差异 | 2025-2024 | 数字 (目前为0) |
| 新店毛利（未税）_2025年 | 2025年新店毛利额 | 数字 |
| 2025年新老店合计_毛利额 | 老店+新店毛利额 | 数字 |
| 2025年新老店合计_同比增长率_毛利 | 合计同比增长率 | 百分比 (目前为0) |

### 特殊行说明

**合计行**
```
合计 = 黄金 + 钻石 + 爱尚炫 + 18K + 翡翠 + 其他
```
**注意**: 不包含"黄金外采-新模式"

**总计行**
```
总计 = 合计 + 黄金外采-新模式
```
**注意**: 包含所有品类

## ⚠️ 重要注意事项

1. **组织名称处理**: 
   - 末尾的*和M会被自动去除
   - 只保留以M结尾的门店 (去除空格后判断)

2. **新老店判断依据**: 
   - 唯一依据: 组织匹配表中的"2025年新店"字段
   - "是" = 新店, 其他 = 老店

3. **已闭店处理**: 
   - 所有数据源都会剔除已闭店数据
   - 依据: 组织匹配表中的"已闭店"字段

4. **缺失组织处理**: 
   - 不在组织匹配表中的组织会被视为老店
   - 系统会输出警告提示

5. **税率说明**:
   - 常规品类毛利: 除以1.13 (13%增值税)
   - 黄金外采-新模式: 除以1.06 (6%增值税)

6. **数据类型转换**:
   - 所有金额字段都会转换为数字类型
   - 转换失败的值会被填充为0

## 📝 核验检查清单

- [ ] 组织匹配表包含所有门店
- [ ] 2025年新店标记正确
- [ ] 已闭店标记正确
- [ ] 入库单过滤规则符合业务需求
- [ ] 其他结算单筛选条件正确
- [ ] 常规品类计算公式正确
- [ ] 黄金外采-新模式计算公式正确
- [ ] 合计和总计计算逻辑正确
- [ ] 输出格式符合要求
