---
name: franchise-store-analysis
description: 分析加盟店新老店的批发额和毛利情况，按品类统计2025年新店和老店数据。支持多表自动合并，其他结算单自动过滤未扣款数据。使用时需要提供销售结算明细、退货结算明细和组织匹配表。自动剔除已闭店数据，区分新老店，按黄金、钻石、爱尚炫、18K、翡翠等品类生成批发额和毛利额报表。
---

# 加盟新老店批发毛利分析

自动分析加盟店新老店的批发额和毛利情况，按品类统计并生成汇总报表。

## 核心功能

1. **区分新老店**: 根据组织匹配表自动识别2025年新开店和老店
2. **剔除闭店**: 自动过滤已关闭的门店数据
3. **多表自动合并**: 支持多个相似Excel表格自动合并后再分析
4. **智能过滤**: 其他结算单自动过滤"未扣款"数据，只保留"已扣款"状态
5. **按品类统计**: 支持黄金、钻石、爱尚炫、18K、翡翠、其他等品类
6. **计算指标**:
   - **常规品类**(黄金/钻石/爱尚炫/18K/翡翠/其他):
     - 老店批发（含税）= 销售金额 - 退回金额
     - 新店批发（含税）= 销售金额 - 退回金额
     - 老店毛利（未税）= (销售金额 - 暂估成本)/1.13 - (退回金额 - 暂估成本)/1.13
     - 新店毛利（未税）= (销售金额 - 暂估成本)/1.13 - (退回金额 - 暂估成本)/1.13
   - **黄金外采-新模式**(特殊计算):
     - 根据组织匹配表区分新店/老店
     - 老店批发（含税）= 老店入库单"总成本" + 老店其他结算单"发生金额"/1.06
     - 新店批发（含税）= 新店入库单"总成本" + 新店其他结算单"发生金额"/1.06
     - 老店毛利（未税）= 老店其他结算单"发生金额"/1.06
     - 新店毛利（未税）= 新店其他结算单"发生金额"/1.06

## 使用方法

### 准备数据文件

需要准备以下Excel文件：

**必需文件（3个）**：
1. **销售结算明细表**：包含"组织"、"品类"、"销售金额"、"暂估成本"等列
2. **退货结算明细表**：包含"组织"、"品类"、"退回金额"、"暂估成本"等列
3. **组织匹配表**：包含"加盟门店"、"2025年新店"、"已闭店"等列

**可选文件（2个）**：
4. **加盟入库单**：包含"组织"、"加盟收货单"、"创建时间"等列（会应用特殊过滤规则）
5. **其他结算单**：包含"加盟门店"、"状态"、"结算类型"、"发生金额"等列（自动过滤未扣款数据）

**多表合并支持**：
- 所有文件参数均支持传入文件列表进行自动合并
- 例如：多个销售表、多个退货表会自动合并后再分析
- 使用Python列表格式传递多个文件路径

### 运行分析

```bash
python3 scripts/analyze_new_old_stores.py <销售文件> <退货文件> <组织匹配表> [入库单文件] [输出文件]
```

示例：

```bash
# 不包含入库单
python3 scripts/analyze_new_old_stores.py 销售.xlsx 退货.xlsx 组织匹配.xlsx

# 包含入库单（会应用特殊过滤规则）
python3 scripts/analyze_new_old_stores.py 销售.xlsx 退货.xlsx 组织匹配.xlsx 入库.xlsx

# 指定输出文件名
python3 scripts/analyze_new_old_stores.py 销售.xlsx 退货.xlsx 组织匹配.xlsx 入库.xlsx 结果.xlsx
```

### 2024 vs 2025年度对比分析（新功能）

用于生成2024年和2025年的完整对比报表，自动按年份过滤黄金外采数据：

```bash
python3 scripts/compare_years.py <2024销售> <2024退货> <2025销售> <2025退货> <组织匹配表> <入库单> <其他结算单> [输出文件]
```

示例：

```bash
python3 scripts/compare_years.py \
  销售2024.xlsx 退货2024.xlsx \
  销售2025.xlsx 退货2025.xlsx \
  组织匹配.xlsx 入库单.xlsx 其他结算单.xlsx \
  2024-2025对比分析.xlsx
```

**输出内容**：
- 双层表头美化报表
- 老店批发/毛利：2024年、2025年、同比增长率、同比差异
- 新店批发/毛利：2025年数据
- 2025年新老店合计：批发额、毛利额、同比增长率
- 黄金外采数据自动按年份过滤（入库单和其他结算单）
- 颜色标识：增长=绿色，下降=红色

### 入库单过滤规则

当提供入库单文件时，会自动应用以下过滤规则：

1. **门店含"宁波开元"**：时间>=2025-01-01的不计入（2024年及之前保留）
2. **门店含"慈溪附海"**：时间>=2025-04-25的不计入（2025-04-25之前保留）
3. **门店含"绍兴斗门"**：不计入（不分年份）
4. **单据编码以"JMCX"开头**：不计入

### 输出说明

生成的Excel文件包含以下列：

- **品类**: 黄金、钻石、爱尚炫、18K、翡翠、其他、合计、黄金外采-新模式、总计
- **老店批发（含税）**: 2024年、2025年、同比增长率、同比差异
- **新店批发（含税）**: 2025年数据
- **2025年新老店合计**: 批发额、同比增长率
- **老店毛利（未税）**: 2024年、2025年、同比增长率、同比差异
- **新店毛利（未税）**: 2025年数据
- **2025年新老店合计**: 毛利额、同比增长率

## 工作流程

1. **读取组织匹配表**: 识别新店和已闭店
2. **读取销售和退货数据**: 加载并处理数据
3. **剔除已闭店**: 过滤掉已关闭门店的所有数据
4. **标记新老店**: 为每条数据标记是新店还是老店
5. **按品类统计**: 分别计算每个品类的批发额和毛利额
6. **生成报表**: 输出包含合计和总计的完整报表

## 注意事项

- 组织名称会自动处理，仅去除末尾的*号（保留M字符）
- 移店、更换加盟商的门店视同老店处理
- "合计"行不包含"黄金外采-新模式"品类
- "总计"行包含所有品类
- 输出为净批发额、净毛利额数据
- **其他结算单过滤规则**：自动过滤"未扣款"数据，只保留"状态=已扣款"且"结算类型=服务费(挂标签）"的记录
- **多表合并**：当提供多个相似表格时，系统会自动合并后再进行分析，无需手动合并
- 目前2024年数据和同比计算功能需要额外配置
