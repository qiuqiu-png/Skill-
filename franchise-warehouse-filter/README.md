# 加盟入库单过滤与核算

自动过滤加盟入库单数据，并进行按件/按克判断和挂签费核算。

## 功能概述

这个Skill可以自动处理加盟入库单Excel文件，执行以下操作：

1. **门店过滤** - 剔除指定门店和时间范围的数据
2. **单据过滤** - 剔除JMCX开头的单据
3. **品类过滤** - 仅保留足金相关品类
4. **智能判断** - 自动判断按件还是按克
5. **费用核算** - 自动核算挂签费

## 快速开始

### 方法1：通过Claude对话

最简单的方式，直接告诉Claude：

```
帮我过滤这个加盟入库单：/Users/nanyu/Desktop/加盟入库单2025-12-24.xlsx
```

### 方法2：Python脚本调用

```python
from scripts.filter_warehouse import filter_and_calculate

# 过滤并核算
result_path = filter_and_calculate(
    input_file="/path/to/加盟入库单.xlsx",
    output_file="/path/to/加盟入库单_已过滤.xlsx"  # 可选
)

print(f"处理完成，结果保存在: {result_path}")
```

### 方法3：命令行运行

```bash
cd ~/.claude/skills/franchise-warehouse-filter/scripts
python filter_warehouse.py /path/to/加盟入库单.xlsx
```

## 过滤规则详解

### 1. 门店过滤规则

| 门店关键词 | 过滤时间范围 | 说明 |
|-----------|-------------|------|
| 宁波开元 | >= 2025-01-01 | 仅剔除2025年1月1日及之后的数据 |
| 附海 | >= 2025-04-25 | 仅剔除2025年4月25日及之后的数据 |
| 斗门 | 全部 | 剔除所有年份的绍兴斗门数据 |

### 2. 单据过滤规则

剔除所有单据编码以 `JMCX` 开头的记录。

### 3. 品类保留规则

仅保留以下大类：
- 足金
- 足金（新）
- 爱尚金

## 核算规则详解

### 按件/按克判断

根据 **基础价** 列判断：
- 基础价 **不为空** → 按件
- 基础价 **为空** → 按克

### 挂签费核算

#### 按件产品
```
挂签费 = 基础价 × 0.04
```

**示例**：
- 基础价：970元
- 挂签费：970 × 0.04 = **38.80元**

#### 按克产品

根据款式名称不同，使用不同的系数：

| 款式特征 | 计算公式 | 系数 |
|---------|---------|------|
| 含"金条" | 总重 × 5 | 5 |
| 含"笼统款"且不含3D/5G | 总重 × 13 | 13 |
| 含"笼统款"且含3D或5G | 总重 × 28 | 28 |
| 其他 | 0 | 0 |

**示例1（金条）**：
- 款式：足金金条
- 总重：50克
- 挂签费：50 × 5 = **250元**

**示例2（笼统款-不含3D/5G）**：
- 款式：笼统款S（手镯）
- 总重：10.5克
- 挂签费：10.5 × 13 = **136.50元**

**示例3（笼统款-含3D）**：
- 款式：笼统款S（3D按件挂坠）
- 总重：3.5克
- 但基础价不为空，所以是按件，不适用此规则

**示例4（笼统款-含5G）**：
- 款式：笼统款S（5G耳饰）
- 总重：3.04克
- 挂签费：3.04 × 28 = **85.12元**

## 输出说明

输出的Excel文件包含：

1. **原始所有列** - 保持不变
2. **新增列1：按件/按克** - 判断结果（"按件" 或 "按克"）
3. **新增列2：挂签费核算** - 核算金额（单位：元）

新增列位于原表的最后两列。

## 数据要求

输入的Excel文件必须包含以下列：

| 必需列 | 说明 |
|--------|------|
| 组织 | 门店组织名称 |
| 创建时间 | 单据创建时间 |
| 加盟收货单 | 单据编码 |
| 大类 | 商品大类 |
| 款式 | 商品款式名称 |
| 基础价 | 基础价格（判断按件/按克的依据） |
| 总重 | 商品总重量 |

## 实际运行示例

```
原始数据行数: 28709

过滤统计:
  剔除宁波开元(2025-01-01后): 220
  剔除慈溪附海(2025-04-25后): 639
  剔除绍兴斗门(全部): 4793
  剔除JMCX开头单据: 1052
  保留指定大类: 28592
  总共剔除: 6821 条

过滤后数据行数: 21888

按件/按克统计:
  按克: 15500
  按件: 6388

大类分布:
  足金: 21888

挂签费核算统计:
  最小值: 1.17 元
  最大值: 1306.89 元
  平均值: 104.62 元
  总金额: 2289862.56 元

✅ 完成！共处理 21888 条数据
```

## 注意事项

1. **数据备份**：过滤会剔除大量数据，建议先备份原始文件
2. **时间格式**：创建时间列必须是有效的日期格式
3. **文件覆盖**：输出文件会覆盖同名文件
4. **列名匹配**：确保Excel文件包含所有必需的列，且列名完全一致
5. **编码问题**：建议使用UTF-8编码保存Excel文件

## 常见问题

### Q1: 为什么"足金（新）"和"爱尚金"被全部过滤了？

A: 因为这两个品类的所有单据编码都是JMCX开头，被单据过滤规则剔除了。如果需要保留，请调整过滤规则。

### Q2: 挂签费核算结果为0是正常的吗？

A: 是的。如果商品的款式名称不包含"金条"、"笼统款"等关键词，且基础价为空，挂签费会核算为0。

### Q3: 如何修改过滤规则？

A: 编辑 `scripts/filter_warehouse.py` 文件，修改对应的过滤条件即可。

### Q4: 可以同时处理多个文件吗？

A: 当前版本不支持批量处理。如需批量处理，建议先合并Excel文件，或使用循环调用脚本。

## 更新日志

### v1.0.0 (2025-12-24)
- 初始版本发布
- 支持门店过滤（宁波开元、慈溪附海、绍兴斗门）
- 支持单据过滤（JMCX开头）
- 支持品类过滤（足金、足金（新）、爱尚金）
- 支持按件/按克自动判断
- 支持挂签费自动核算

## 技术支持

如有问题或建议，请联系开发团队。

## 许可证

内部使用工具，仅供授权人员使用。
