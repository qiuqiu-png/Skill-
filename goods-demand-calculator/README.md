# 货盘需求计算器

自动化计算珠宝门店的补货需求量，支持普通商品和DIY商品的差异化需求规则。

## 功能特性

✅ **智能筛选**：自动筛选符合条件的商品（足金/足金（新）、21天周期、有补单数）
✅ **门店识别**：自动识别所有门店及其对应的库存、销售、在途、需求列
✅ **差异化规则**：DIY商品和普通商品使用不同的需求计算公式
✅ **数据保护**：完整保留原表格式、公式、合并单元格
✅ **批量处理**：一次性处理所有门店的需求计算

## 需求计算规则

### 普通商品

| 条件 | 需求值 |
|------|--------|
| 库存+在途-销售 < 0 | \|库存+在途-销售\| |
| 库存+在途-销售 = 0 | 1 |
| 库存+在途-销售 > 0 | 不填充 |

### DIY商品（二级分类=DIY）

| 条件 | 补单重量 | 销售量 | 需求值 |
|------|----------|--------|--------|
| 库存+在途-销售 < 0 | > 500克 | - | \|库存+在途-销售\| × 5 |
| 库存+在途-销售 < 0 | ≤ 500克 | - | \|库存+在途-销售\| × 2 |
| 库存+在途-销售 = 0 | - | - | 1 |
| 库存+在途-销售 > 0 | - | > 1 | 1 |
| 库存+在途-销售 > 0 | - | ≤ 1 | 不填充 |

## 使用方法

### 直接使用

```bash
python3 calculate_demand.py <输入文件路径> [输出文件路径]
```

### 示例

```bash
# 自动生成输出文件名
python3 calculate_demand.py /Users/nanyu/Desktop/货盘数据57.7.xlsx

# 指定输出文件名
python3 calculate_demand.py 货盘数据.xlsx 货盘数据_已处理.xlsx
```

### 在Claude Code中使用

直接告诉Claude处理货盘数据文件即可，skill会自动调用。

## 输入文件要求

### 必需的列

- **B列**：大类（足金、足金（新）等）
- **E列**：二级分类（DIY、其他等）
- **G列**：周期类型（21天周期等）
- **CI列**：补单数量
- **CJ列**：补单重量（克）

### 必需的门店数据结构

- **第6行**：门店名称（合并单元格）
- **第7行**：列标题（库存、销售、在途、需求）
- **DS~YD列**：门店数据区域

### 示例结构

```
第6行:  | 顺丰现货云仓     | 2A--合肥高新银泰店 |
第7行:  | 库存 | 销售 | 在途 | 需求 | 库存 | 销售 | 在途 | 需求 |
```

## 处理逻辑

1. **加载文件**：读取Excel文件
2. **识别门店**：扫描第6行，找到所有门店及其列范围
3. **筛选数据**：筛选B列=足金/足金（新）、G列=21天周期、CI列>0的行
4. **计算需求**：
   - 读取每行的二级分类（是否为DIY）
   - 读取补单重量（DIY商品需要）
   - 对每个门店计算库存+在途-销售
   - 根据商品类型应用相应规则
   - 填充需求列
5. **保存文件**：输出处理后的Excel文件

## 特殊处理

🚫 **忽略的门店**：销售 ≤ 0 或为空值的门店不计算需求
📐 **公式保留**：原表中的所有公式完整保留
🎨 **格式保留**：单元格格式、合并单元格完整保留

## 依赖项

```bash
pip3 install openpyxl
```

## 输出说明

- 输出文件默认在原文件名后添加 `_处理后` 后缀
- 只修改"需求"列的数值，其他所有数据保持不变
- 处理完成后会显示填充的单元格数量

## 版本历史

### v2.1 (2024-12-24)
- ✅ 优化DIY商品calc>0规则：仅当销售>1时填充需求=1
- ✅ 更新文档说明，增加销售量判断条件

### v2.0 (2024-12-24)
- ✅ 新增G列周期类型筛选（21天周期）
- ✅ 新增DIY商品差异化计算规则
- ✅ 新增补单重量阈值判断（500克）
- ✅ 优化门店识别逻辑
- ✅ 更新文档说明

### v1.0 (2024-12-23)
- ✅ 初始版本
- ✅ 基础需求计算功能
- ✅ 门店自动识别
- ✅ 格式保留功能

## 注意事项

⚠️ **文件结构**：确保第6、7行的门店结构符合要求
⚠️ **列顺序**：每个门店的4列必须按"库存、销售、在途、需求"顺序排列
⚠️ **数据类型**：库存、销售、在途、补单数量、补单重量必须为数值
⚠️ **处理时间**：大型文件（4000+行）可能需要1-2分钟处理时间

## 疑难解答

**Q: 为什么某些门店没有填充需求？**
A: 检查该门店的销售数据是否 > 0，销售 ≤ 0 的门店会被忽略。

**Q: DIY商品的需求值为什么和普通商品不同？**
A: DIY商品有特殊的倍率规则（2倍或5倍），且在库存充足时也会填充需求。

**Q: 输出文件丢失了原有的公式？**
A: 本skill已保留所有公式，如遇到问题请检查openpyxl版本是否最新。

## 技术支持

如遇到问题，请提供：
1. 输入文件的前10行截图
2. 错误信息（如果有）
3. 处理的行数和预期结果
